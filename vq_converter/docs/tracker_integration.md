# PokeyVQ Tracker Integration Guide

This document describes the output format and metadata generated by `PokeyVQ` for use in external tools, specifically the **Music Tracker**.

## Output Directory Structure

When `pokey_vq` processes audio (especially in `vq_samples` or `tracker` mode), it creates a directory structure containing both the Atari executable/data and PC-friendly metadata.

```text
output_folder/
├── conversion_info.json    # MAIN METADATA (See below)
├── instruments/            # Directory containing simulated WAVs
│   ├── 001.wav             # Simulated audio for Sample #1
│   ├── 002.wav             # Simulated audio for Sample #2
│   └── ...
├── SAMPLE_DIR.asm          # Atari ASM: Sample Start/End tables
├── VQ_INDICES.asm          # Atari ASM: The sequence of indices (The "Song Data")
├── VQ_BLOB.asm             # Atari ASM: The Codebook Data (Packed)
├── VQ_LENS.asm             # Atari ASM: Lengths of codebook vectors
├── VQ_CFG.asm              # Atari ASM: Configuration constants
└── ... (Other VQ_* files)
```

## JSON Metadata (`conversion_info.json`)

The `conversion_info.json` file provides all necessary information to reconstruct the session in a PC Tracker.

### Structure

```json
{
    "config": {
        "rate": 7917.17,        // The actual playback rate (Hz) matching POKEY divisor
        "pokey_divisor": 7,     // The hardware POKEY divisor used ($07)
        "channels": 2,          // 1 (Mono) or 2 (Stereo)
        "codebook_size": 256,   // Number of entries in the codebook
        "min_vector": 1,        // Minimum vector length (in samples)
        "max_vector": 16,       // Maximum vector length (in samples)
        "algorithm": "fixed"    // Algorithm used ("fixed" = VQ, "raw" = Stream)
    },
    "samples": [
        {
            "original_file": "bass_drum.wav",       // Original filename
            "original_path": "/abs/path/to/src.wav",// Full path to source file
            "instrument_file": "/path/to/output/instruments/001.wav", // Path to simulated WAV
            "index_start": 0,    // Start Offset in VQ_INDICES (Inclusive)
            "index_end": 154,    // End Offset in VQ_INDICES (Exclusive)
        },
        {
            "original_file": "snare.wav",
            "instrument_file": "/path/to/output/instruments/002.wav",
            "index_start": 154,
            "index_end": 302,
        }
    ]
]
```

### Usage for Tracker

1.  **Loading Instruments**: Use `instrument_file` paths to load the WAV previews for each instrument. These WAVs are generated using the exact VQ codebook and POKEY simulation, providing an accurate representation of how the sample sounds on hardware.
2.  **Mapping Indices**: The `index_start` and `index_end` fields tell you exactly which slice of the `VQ_INDICES` stream corresponds to this sample.
    *   To play "Sample 1" on Atari, the player sets its pointer to `VQ_INDICES + index_start` and plays until `index_end`.
3.  **Timing**: The duration of a sample in seconds is `(Total Indices * Avg Vector Length) / Rate`. Since vector length varies, strict time calculation requires summing the lengths from `VQ_LENS` for the range `[index_start, index_end)`.

## ASM Files (Atari Data)

These files are included by the Atari player (`player.asm`).

| File | Description |
|------|-------------|
| `VQ_INDICES.asm` | The detailed sequence data. Each byte is an index into the codebook. This is essentially the "Sheet Music" for the samples. |
| `VQ_BLOB.asm` | The simplified/packed Codebook data. Contains the raw POKEY nibbles. |
| `VQ_LENS.asm` | Array containing the length (duration in hardware ticks) of each codebook vector. `Card[i]` is length of Vector `i`. |
| `SAMPLE_DIR.asm` | **Important**: This file provides a lookup table for the Atari player to access samples by ID. |

### Structure of `SAMPLE_DIR.asm`

This file is automatically generated for multi-sample modes. It contains 4 tables:

```asm
SAMPLE_COUNT = 2

SAMPLE_START_LO
 .byte <(VQ_INDICES+$0000) ; bass_drum.wav
 .byte <(VQ_INDICES+$009A) ; snare.wav

SAMPLE_START_HI
 .byte >(VQ_INDICES+$0000) ; bass_drum.wav
 .byte >(VQ_INDICES+$009A) ; snare.wav

SAMPLE_END_LO ...
SAMPLE_END_HI ...
```

The comments in this file (e.g., `; bass_drum.wav`) match the `original_file` field in the JSON. The tracker can rely on the index in the `samples` JSON array matching the index in these ASM tables (Sample 0 is 1st entry, Sample 1 is 2nd).
